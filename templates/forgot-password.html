<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{title}}</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

        <link
            href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap"
            rel="stylesheet">

        <style>
            html,
            body {
                height: 100%;
                margin: 0;
            }

            body {
                display: flex;
                justify-content: center;
                align-items: flex-start;
                padding-top: 80px;
                font-family: 'Plus Jakarta Sans', sans-serif;
                background-color: rgb(249, 249, 249);


            }

            .center-content {
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                text-align: center;
                width: 100%;
                max-width: 1000px;
                margin-left: auto;
                margin-right: auto;

            }

            .logo-wrapper {
                display: flex;
                justify-content: center;
                margin-bottom: 40px;
            }

            .logo-container {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            @media (max-width: 768px) {
                .center-content {
                    padding: 0 40px;
                }
            }

            /* Media query for mobile phones */
            @media (max-width: 480px) {
                .center-content {
                    padding: 0 20px;
                    font-size: 0.9rem;
                }
            }

            @media (min-width: 1200px) {
                .center-content {
                    max-width: 1200px;
                }
            }

            .card {
                background: white;
                /* Solid white background */
                border-radius: 10px;
                /* Rounded corners */
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                /* Soft shadow */
                margin: auto;
                /* Center the card */
                max-width: 600px;
                /* Maximum width */
            }

            /* Responsive Padding */
            .center-content {
                padding: 2rem;
                /* Default padding for smaller screens */
            }

            @media (min-width: 640px) {
                .center-content {
                    padding: 3rem;
                    /* Padding for medium screens */
                }
            }

            @media (min-width: 768px) {
                .center-content {
                    padding: 4rem;
                    /* Padding for larger screens */
                }
            }
        </style>
    </head>

    <body>

        <div class="flex items-center justify-center min-h-screen bg-gray-50">
            <div class="center-content card p-6 sm:p-8 md:p-10 lg:p-12 mx-auto max-w-lg">

                <div id="initialResetContent">
                    <div class="logo-wrapper">
                        <a href="/" class="logo-container flex items-center mb-4 sm:mb-0 space-x-3 rtl:space-x-reverse">
                            <img src="https://flowbite.com/docs/images/logo.svg" class="h-8" alt="Flowbite Logo" />
                            <span
                                class="self-center text-xl sm:text-2xl font-semibold whitespace-nowrap dark:text-white">Smart Parichaya</span>
                        </a>
                    </div>
                    <h2 class="text-4xl font-extrabold dark:text-white mb-4">Forgot password?</h2>
                    <p id="instructionText"
                        class="mb-6 text-base sm:text-lg lg:text-l text-gray-500 dark:text-gray-400">
                        Enter your registered email address where we can send a verification code to reset your
                        password.
                    </p>

                    <!-- OTP form (Initial form) -->
                    <form id="otpForm" class="space-y-6 w-full" method="POST">
                        {% csrf_token %}
                        <div class="relative mb-6">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                                    xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 16">
                                    <path
                                        d="m10.036 8.278 9.258-7.79A1.979 1.979 0 0 0 18 0H2A1.987 1.987 0 0 0 .641.541l9.395 7.737Z" />
                                    <path
                                        d="M11.241 9.817c-.36.275-.801.425-1.255.427-.428 0-.845-.138-1.187-.395L0 2.6V14a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V2.5l-8.759 7.317Z" />
                                </svg>
                            </div>
                            <input id="pwResetEmail"
                                class="block w-full pl-10 p-2 border rounded-md focus:outline-none focus:ring focus:ring-primary-100"
                                type="email" name="email" placeholder="Email address" required="">
                        </div>

                        <div>
                            <button type="submit"
                                class="w-full px-4 py-2 font-medium text-center text-white bg-blue-600 transition-colors duration-200 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-offset-1">
                                Send code
                            </button>
                        </div>
                        <a href="/login/"
                            class="inline-flex items-center font-medium text-blue-600 dark:text-blue-500 hover:underline">
                            Go to login page
                            <svg class="w-4 h-4 ms-2 rtl:rotate-180" aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9" />
                            </svg>
                        </a>
                    </form>

                </div>


                <div id="finalResetContent" style="text-align: left;" class="hidden">
                    <div class="logo-wrapper">
                        <a href="/" class="logo-container flex items-center mb-4 sm:mb-0 space-x-3 rtl:space-x-reverse">
                            <img src="https://flowbite.com/docs/images/logo.svg" class="h-8" alt="Flowbite Logo" />
                            <span
                                class="self-center text-xl sm:text-2xl font-semibold whitespace-nowrap dark:text-white">Smart Parichaya</span>
                        </a>
                    </div>
                    <h2 class="text-4xl font-extrabold dark:text-white mb-4">Change password</h2>
                    <p id="instructionText"
                        class="mb-6 text-base sm:text-lg lg:text-l text-gray-500 dark:text-gray-400">
                        Make sure to use a strong password and remember it in order to login for the next time.
                    </p>

                    <!-- New pw reset form (Final form) -->
                    <form id="passwordResetForm" class="space-y-6 w-full" method="POST">
                        {% csrf_token %}
                        <div>
                            <label for="password"
                                class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">New
                                Password</label>
                            <input type="password" name="password" id="password"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                required="">
                        </div>

                        <div>
                            <label for="confirm-password"
                                class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Confirm
                                Password</label>
                            <input type="password" name="confirm-password" id="confirm-password"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                required="">
                        </div>

                        <div>
                            <button type="submit"
                                class="w-full px-4 py-2 font-medium text-center text-white bg-blue-600 transition-colors duration-200 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-offset-1">
                                Reset Password
                            </button>
                        </div>
                    </form>

                </div>

            </div>
        </div>



        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>




        <script>
            $(document).ready(function () {
                let ongoingOperation = false;

                // Function to censor the email address
                function censorEmail(email) {
                    const [localPart, domain] = email.split('@');
                    const censoredLocalPart = localPart.length > 4 ? localPart[0] + '**' + localPart.slice(-2) : localPart;
                    return `${censoredLocalPart}@${domain}`;
                }

                // Handle the OTP form submission
                $('#otpForm').submit(function (event) {
                    event.preventDefault();
                    ongoingOperation = true;
                    let email = $('#pwResetEmail').val();

                    $.ajax({
                        url: '/forgot-password/',
                        method: 'POST',
                        data: {
                            email: email,
                            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                        },
                        beforeSend: function () {
                            Swal.fire({
                                title: 'Sending verification code to your email. Please wait...',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                        },
                        success: function (response) {
                            Swal.close(); // Close loading alert

                            if (response.status === 'otp_sent') {
                                const censoredEmail = censorEmail(email);
                                Swal.fire({
                                    title: 'Verification code sent!',
                                    text: 'Please check your email for the OTP.',
                                    icon: 'success',
                                    confirmButtonText: 'OK',
                                    confirmButtonColor: '#3085d6',
                                    allowOutsideClick: false
                                }).then(() => {
                                    // Open the OTP input popup
                                    showOtpPopup(censoredEmail);
                                });
                            } else {
                                handleErrorResponse(response);
                            }
                        },
                        error: function (xhr) {
                            ongoingOperation = false;
                            console.error('Error:', xhr.responseText);
                            const response = xhr.responseJSON;
                            if (response && response.status === 'email_not_found') {
                                // Handle the case where email is not found
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'The email address you entered is not registered.',
                                    icon: 'error',
                                    confirmButtonText: 'OK',
                                    confirmButtonColor: '#3085d6',
                                    allowOutsideClick: false
                                });
                            } else {
                                // Generic error handler
                                handleErrorResponse(response);
                            }
                        }
                    });
                });

                // Beforeunload event to warn users about page reload
                window.onbeforeunload = function (event) {
                    if (ongoingOperation) {
                        const message = "Reloading the page will abort all ongoing operations. Are you sure you want to proceed?";
                        event.returnValue = message;
                        return message;
                    }
                };

                // Function to handle error responses
                function handleErrorResponse(response) {
                    Swal.fire({
                        title: 'Error!',
                        text: response.message || 'An unexpected error occurred. Please try again later.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#3085d6',
                        allowOutsideClick: false
                    }).then(() => {
                        $('#otpForm')[0].reset();  // Reset the form
                    });
                }

                // Function to show OTP input popup
                function showOtpPopup(censoredEmail) {
                    Swal.fire({
                        title: 'Email Verification',
                        html: `
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <p style="text-align: center; margin-bottom: 20px;">Please enter the 6-digit code we sent to <strong>${censoredEmail}</strong>.</p>
                                <input type="number" id="otpInput" class="form-control" placeholder="Enter OTP" required maxlength="6" style="width: 250px;"/>
                            </div>
                        `,
                        focusConfirm: false,
                        confirmButtonText: 'Verify Account',
                        confirmButtonColor: '#3085d6',
                        allowOutsideClick: false,
                        preConfirm: () => {
                            const otp = $('#otpInput').val();
                            if (!otp || otp.length < 6) {
                                Swal.showValidationMessage('Please provide a valid 6-digit OTP');
                                return false;
                            }
                            verifyOtp(otp, $('#pwResetEmail').val());
                        }
                    });
                }

                // Verify OTP function (updated to reflect new verify OTP URL)
                function verifyOtp(otp, email) {
                    $.ajax({
                        url: '/verify-otp-for-password/',  // Update to the correct view URL
                        method: 'POST',
                        data: {
                            otp: otp,
                            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                        },
                        success: function (response) {
                            if (response.status === 'otp_verified') {
                                Swal.fire({
                                    title: 'OTP Verified!',
                                    icon: 'success',
                                    timer: 2000,
                                    showConfirmButton: false,
                                    allowOutsideClick: false
                                }).then(() => {
                                    $('#otpForm').hide();
                                    $('#initialResetContent').addClass('hidden');
                                    $('#finalResetContent').removeClass('hidden');

                                    // Handle password reset form submission
                                    handlePasswordReset(email);
                                });
                            } else {
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'Invalid OTP. Please try again.',
                                    icon: 'error',
                                    confirmButtonText: 'OK',
                                    confirmButtonColor: '#3085d6',
                                    allowOutsideClick: false
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                title: 'Error!',
                                text: 'An error occurred while verifying OTP.',
                                icon: 'error',
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#3085d6',
                                allowOutsideClick: false
                            });
                        }
                    });
                }

                // Function to handle password reset
                function handlePasswordReset(email) {
                    $('#passwordResetForm').submit(function (event) {
                        event.preventDefault();

                        const newPassword = $('#password').val();
                        const confirmPassword = $('#confirm-password').val();

                        // Check if new password and confirm password match
                        if (newPassword !== confirmPassword) {
                            Swal.fire({
                                title: 'Error!',
                                text: 'New password and confirm password do not match.',
                                icon: 'error',
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#3085d6',
                                allowOutsideClick: false
                            });
                            return;
                        }

                        // Show processing alert
                        const processingAlert = Swal.fire({
                            title: 'Processing... Please wait!',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        // Proceed to update password
                        $.ajax({
                            url: '/update-password/',
                            method: 'POST',
                            data: {
                                email: email,
                                new_password: newPassword,
                                csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                            },
                            success: function (response) {
                                console.log("Response from server:", response);
                                processingAlert.close(); // Close the processing alert
                                if (response.status === 'success') {
                                    Swal.fire({
                                        title: 'Success!',
                                        text: 'Your password has been updated successfully.',
                                        icon: 'success',
                                        confirmButtonText: 'OK',
                                        confirmButtonColor: '#3085d6',
                                        allowOutsideClick: false
                                    }).then(() => {
                                        ongoingOperation = false,
                                            window.location.href = '/login/';
                                    });
                                } else {
                                    // Handle all other statuses returned from the server
                                    handlePasswordErrorResponse(response);
                                }
                            },
                            error: function (xhr) {
                                processingAlert.close(); // Close the processing alert
                                // Handle error based on server response
                                handlePasswordErrorResponse(xhr.responseJSON);
                            }
                        });
                    });
                }

                // Function to handle password error responses
                function handlePasswordErrorResponse(response) {
                    if (response.status === 'same_as_current') {
                        Swal.fire({
                            title: 'Error!',
                            text: 'New password cannot be the same as the current password.',
                            icon: 'error',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#3085d6',
                            allowOutsideClick: false
                        });
                    } else {
                        Swal.fire({
                            title: 'Error!',
                            text: response.message || 'An unexpected error occurred. Please try again later.',
                            icon: 'error',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#3085d6',
                            allowOutsideClick: false
                        });
                    }
                }
            });
        </script>




















    </body>

</html>