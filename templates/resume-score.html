{% extends 'testuserAuth.html' %} {% block content %}

<div
  id="resume-score-test-content"
  class="tab-content p-4 border-2 border-gray-200 border-dashed rounded-lg dark:border-gray-700 mt-14 bg-gray-50/50"
>
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Resume AI Analyzer</h2>
    <span
      class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded-full uppercase tracking-wider"
      >Beta</span
    >
  </div>

  <div
    class="flex flex-col lg:flex-row items-stretch justify-center gap-6 p-4 md:p-8 bg-white rounded-2xl shadow-sm border border-gray-100"
  >
    <div
      class="flex-1 flex flex-col justify-center text-center lg:text-left space-y-6"
    >
      <div>
        <h2
          class="text-2xl md:text-3xl font-extrabold text-gray-900 leading-tight"
        >
          Get instant feedback based on
          <span class="text-blue-600">industry standards</span>
        </h2>
        <p class="mt-4 text-gray-600 leading-relaxed">
          Our AI analyzes your resume for keywords, formatting, and impact.
          Upload your PDF to see where you stand among top candidates.
        </p>
      </div>

      <div class="relative group hidden md:block">
        <img
          src="/static/resume-builder-images/evalImg.png"
          alt="Feedback preview"
          class="rounded-xl shadow-lg transform transition group-hover:scale-[1.02] duration-300"
        />
        <div
          class="absolute inset-0 bg-gradient-to-t from-white/20 to-transparent rounded-xl"
        ></div>
      </div>

      <div class="pt-4 border-t border-gray-100">
        <p class="text-sm text-gray-500">
          Donâ€™t have a resume yet?
          <a
            href="/testUserAuth/cv-builder/"
            class="inline-flex items-center font-semibold text-blue-600 hover:text-blue-700"
          >
            Build one in minutes
            <svg
              class="w-4 h-4 ml-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </a>
        </p>
      </div>
    </div>

    <div
      class="flex-1 bg-blue-50/50 rounded-2xl p-6 md:p-10 border-2 border-dashed border-blue-200 transition-all hover:border-blue-400"
      id="dropZone"
    >
      <div class="text-center space-y-4">
        <h3 class="text-lg font-bold text-gray-800">Upload Resume</h3>
        <p class="text-sm text-gray-500">
          Supported format:
          <span class="font-mono font-bold text-blue-600">.PDF</span>
        </p>

        <form
          id="resumeForm"
          method="POST"
          enctype="multipart/form-data"
          class="space-y-6"
        >
          {% csrf_token %}

          <label for="resumeFileInput" class="cursor-pointer group block">
            <div
              class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 group-hover:shadow-md transition-all"
            >
              <div class="flex flex-col items-center">
                <div
                  class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors"
                >
                  <svg
                    class="w-8 h-8"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                    ></path>
                  </svg>
                </div>
                <span
                  class="text-sm font-medium text-gray-700"
                  id="fileLabelText"
                  >Click or Drag & Drop to upload</span
                >
                <p
                  id="selectedFileName"
                  class="mt-2 text-blue-600 font-bold text-xs truncate max-w-xs hidden"
                ></p>
              </div>
            </div>
            <input
              type="file"
              accept=".pdf"
              name="resume"
              id="resumeFileInput"
              class="hidden"
            />
          </label>

          <button
            id="testScoreButton"
            type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-blue-200 transform transition active:scale-95 disabled:opacity-50"
          >
            Analyze My Resume
          </button>
        </form>

        <p class="text-[10px] text-gray-400 italic">
          *By analyzing your resume, you agree to receive personalized job
          recommendations.
        </p>
      </div>
    </div>
  </div>

  <div class="mt-12 bg-white rounded-2xl p-8 shadow-sm">
    <h2 class="text-center text-2xl font-bold text-gray-800 mb-12">
      How it Works?
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-12 relative">
      <div class="relative flex flex-col items-center text-center group">
        <div
          class="w-20 h-20 bg-blue-50 rounded-2xl flex items-center justify-center mb-6 transform transition group-hover:rotate-6"
        >
          <img
            src="/static/resume-builder-images/step1.png"
            alt="Step 1"
            class="w-12 h-12"
          />
        </div>
        <h3 class="text-lg font-bold text-gray-800">1. Upload</h3>
        <p class="text-sm text-gray-500 mt-2">
          Simply attach your PDF resume from your device.
        </p>
      </div>

      <div class="relative flex flex-col items-center text-center group">
        <div
          class="w-20 h-20 bg-blue-50 rounded-2xl flex items-center justify-center mb-6 transform transition group-hover:rotate-6"
        >
          <img
            src="/static/resume-builder-images/step2.png"
            alt="Step 2"
            class="w-12 h-12"
          />
        </div>
        <h3 class="text-lg font-bold text-gray-800">2. Analyze</h3>
        <p class="text-sm text-gray-500 mt-2">
          Our algorithm scans 20+ parameters used by HRs.
        </p>
      </div>

      <div class="relative flex flex-col items-center text-center group">
        <div
          class="w-20 h-20 bg-blue-50 rounded-2xl flex items-center justify-center mb-6 transform transition group-hover:rotate-6"
        >
          <img
            src="/static/resume-builder-images/step3.png"
            alt="Step 3"
            class="w-12 h-12"
          />
        </div>
        <h3 class="text-lg font-bold text-gray-800">3. Result</h3>
        <p class="text-sm text-gray-500 mt-2">
          Get a detailed score and actionable feedback.
        </p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const resumeInput = document.getElementById("resumeFileInput");
    const selectedFileName = document.getElementById("selectedFileName");
    const fileLabelText = document.getElementById("fileLabelText");
    const testScoreButton = document.getElementById("testScoreButton");
    const dropZone = document.getElementById("dropZone");

    let currentSwal = null;

    // --- Drag and Drop Logic ---
    ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
      dropZone.addEventListener(
        eventName,
        (e) => {
          e.preventDefault();
          e.stopPropagation();
        },
        false
      );
    });

    ["dragenter", "dragover"].forEach((eventName) => {
      dropZone.addEventListener(
        eventName,
        () => dropZone.classList.add("bg-blue-100", "border-blue-500"),
        false
      );
    });

    ["dragleave", "drop"].forEach((eventName) => {
      dropZone.addEventListener(
        eventName,
        () => dropZone.classList.remove("bg-blue-100", "border-blue-500"),
        false
      );
    });

    dropZone.addEventListener("drop", (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      resumeInput.files = files;
      handleFiles(files);
    });

    resumeInput.addEventListener("change", () =>
      handleFiles(resumeInput.files)
    );

    function handleFiles(files) {
      const file = files[0];
      if (file) {
        if (file.type !== "application/pdf") {
          Swal.fire("Invalid File", "Please upload a PDF document.", "warning");
          resumeInput.value = "";
          selectedFileName.classList.add("hidden");
          fileLabelText.textContent = "Click or Drag & Drop to upload";
          return;
        }
        selectedFileName.textContent = `Selected: ${file.name}`;
        selectedFileName.classList.remove("hidden");
        fileLabelText.textContent = "File Ready!";
      }
    }

    // --- Form Submission ---
    testScoreButton.addEventListener("click", (event) => {
      event.preventDefault();

      if (!resumeInput.files.length) {
        Swal.fire({
          icon: "error",
          title: "Wait!",
          text: "Please select your PDF resume first.",
        });
        return;
      }

      Swal.fire({
        title: "AI Analysis in Progress",
        html: "Scanning keywords and evaluating formatting...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const formData = new FormData();
      formData.append("resume", resumeInput.files[0]);
      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;

      fetch("/testUserAuth/resume-score/", {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": csrfToken,
        },
      })
        .then((res) => res.json())
        .then((data) => {
          const { score, resultClass } = data;
          let recommendation = "Serenity"; // Default
          if (score > 80) recommendation = "Alien";
          else if (score > 50) recommendation = "Column Mint";

          // Dynamic Chart Color based on resultClass
          const chartColor =
            resultClass === "success"
              ? "#10b981"
              : score > 40
              ? "#f59e0b"
              : "#ef4444";

          Swal.fire({
            title: "Analysis Complete",
            confirmButtonText: "Got it!",
            confirmButtonColor: "#2563eb",
            html: `
            <div class="py-4">
              <div class="relative flex items-center justify-center mx-auto" style="width: 140px; height: 140px;">
                <svg class="transform -rotate-90 w-32 h-32">
                  <circle cx="64" cy="64" r="58" stroke="#e5e7eb" stroke-width="12" fill="transparent" />
                  <circle cx="64" cy="64" r="58" stroke="${chartColor}" stroke-width="12" fill="transparent" 
                    stroke-dasharray="364.4" 
                    stroke-dashoffset="${364.4 - (364.4 * score) / 100}" 
                    stroke-linecap="round" />
                </svg>
                <div class="absolute text-3xl font-black" style="color: ${chartColor}">${score}%</div>
              </div>
              <div class="mt-4">
                <p class="text-sm text-gray-500">Classification</p>
                <p class="text-xl font-bold uppercase tracking-widest ${getClassificationClass(
                  score
                )}">
                  ${getClassificationText(score)}
                </p>
              </div>
            </div>
          `,
          });
        })
        .catch(() => {
          Swal.fire(
            "Error",
            "We couldn't process your resume. Check your internet connection.",
            "error"
          );
        });
    });

    function getClassificationText(s) {
      if (s <= 25) return "Need Improvement";
      if (s <= 50) return "Average";
      if (s <= 75) return "Professional";
      return "Exceptional";
    }

    function getClassificationClass(s) {
      if (s <= 25) return "text-red-600";
      if (s <= 50) return "text-yellow-500";
      if (s <= 75) return "text-blue-600";
      return "text-green-600";
    }
  });
</script>

{% endblock %}
