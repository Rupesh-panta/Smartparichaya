{% extends 'testuserAuth.html' %}
{% block content %}
<!-- Resume Score Test Content -->
<div id="resume-score-test-content"
  class="tab-content p-4 border-2 border-gray-200 border-dashed rounded-lg dark:border-gray-700 mt-14">
  <h2 class="text-2xl font-semibold">Resume Score Test</h2>

  <div class="mt-8 flex flex-col md:flex-row items-center justify-center gap-8 p-8 bg-blue-100">
    <!-- Left Section -->
    <div class="text-center md:text-left">
      <h2 class="text-xl font-semibold mb-4">Get resume feedback report based on your resume content</h2>
      <div class="max-w-md mx-auto">
        <img src="/static/resume-builder-images/evalImg.png" alt="Feedback preview" class="h-auto w-full">
      </div>

      <p class="text-sm text-gray-500">Donâ€™t you have a resume? <a href="/testUserAuth/cv-builder/"
          class="text-blue-600 underline">Get your resume built in a snap !</a></p>
    </div>

    <!-- Right Section -->
    <div
      class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-6 bg-white shadow-md">
      <h3 class="text-lg font-medium mb-4">Upload your resume to evaluate your score</h3>
      <p class="text-sm text-gray-500 mb-4">Click to upload your resume (<span
          class="font-bold text-gray-600">.pdf</span> file format) below:</p>

      <form id="resumeForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="max-w-md mx-auto rounded-lg overflow-hidden md:max-w-xl">
          <div class="md:flex">
            <div class="w-full p-3">
              <div
                class="relative border-dotted h-48 rounded-lg border-dashed border-2 border-blue-700 bg-gray-100 flex justify-center items-center">

                <div class="absolute">
                  <div class="flex flex-col items-center">
                    <i class="fa fa-folder-open fa-4x text-blue-700"></i>
                    <span
                      class="text-center mt-2 block text-gray-400 font-normal text-sm sm:text-base md:text-lg lg:text-xl break-words"
                      style="font-size: 0.85rem;">
                      Attach your files here
                    </span>
                  </div>
                </div>

                <input type="file" accept=".pdf" class="h-full w-full opacity-0" name="resume" id="resumeFileInput">

              </div>
            </div>
          </div>
        </div>


        <!-- Display Selected File Name -->
        <p id="selectedFileName" class="mt-4 text-gray-700 text-sm hidden"></p>
        <div class="flex justify-center mt-4">
          <button id="testScoreButton" type="submit"
            class="mt-1 mb-1 bg-blue-600 text-white font-medium py-2 px-6 rounded-md hover:bg-blue-700">
            Test Score
          </button>
        </div>
      </form>

      <p class="mt-4 text-xs text-gray-500 text-center">
        By checking my CV Score I authorize Simpfolio to recommend me the suitable job opportunities in the future
      </p>
    </div>
  </div>

  <div class="mt-14 bg-white py-8 px-4 sm:px-10 md:px-16">
    <h2 class="mt-2  text-center text-3xl font-extrabold text-gray-800 md:text-3xl mb-16">
      How it <span
        class="underline underline-offset-3 decoration-8 decoration-blue-400 light:decoration-blue-600">Works?</span>
    </h2>
    <div class="mt-14 mb-14 grid grid-cols-1 md:grid-cols-3 gap-16" id="how-it-works">
      <!-- Step 1 -->
      <div class="flex flex-col items-center text-center">
        <img src="/static/resume-builder-images/step1.png" alt="Upload Resume" class="w-24 h-24 mb-4" />
        <h3 class="text-lg font-medium text-gray-800">
          1. Upload Your Resume
        </h3>
        <p class="text-gray-600 mt-2">
          Attach your resume in PDF format from your device.
        </p>
      </div>
      <!-- Step 2 -->
      <div class="flex flex-col items-center text-center">
        <img src="/static/resume-builder-images/step2.png" alt="Algorithm Scores Resume" class="w-24 h-24 mb-4" />
        <h3 class="text-lg font-medium text-gray-800">
          2. Algorithm Scores Resume
        </h3>
        <p class="text-gray-600 mt-2">
          Our algorithm rates your resume using different parameters.
        </p>
      </div>
      <!-- Step 3 -->
      <div class="flex flex-col items-center text-center">
        <img src="/static/resume-builder-images/step3.png" alt="Get Feedback" class="w-24 h-24 mb-4" />
        <h3 class="text-lg font-medium text-gray-800">
          3. Get Feedback Report
        </h3>
        <p class="text-gray-600 mt-2">
          Get feedback ratings based on your resume content.
        </p>
      </div>
    </div>
  </div>
</div>








<style>
  #how-it-works {
    padding-left: 10px;
    padding-right: 10px;
  }

  @media(max-width:1140px) {
    #how-it-works {
      grid-template-columns: 1fr;
      padding-left: 20px;
      padding-right: 20px
    }
  }
</style>


<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const resumeInput = document.getElementById("resumeFileInput");
    const selectedFileName = document.getElementById("selectedFileName");
    const testScoreButton = document.getElementById("testScoreButton");

    let currentSwal = null; // Track the current active SweetAlert

    // Display the selected file name
    resumeInput.addEventListener("change", () => {
      const file = resumeInput.files[0];
      if (file) {
        selectedFileName.textContent = `Selected File: ${file.name}`;
        selectedFileName.classList.remove("hidden");
      } else {
        selectedFileName.textContent = "";
        selectedFileName.classList.add("hidden");
      }
    });

    // Handle Test Score button click
    testScoreButton.addEventListener("click", (event) => {
      event.preventDefault(); // Prevent form submission since we're using AJAX

      if (!resumeInput.files.length) {
        // If no file is selected, show an error alert
        showSwal({
          icon: "error",
          title: "No File Selected",
          text: "Please select a resume file in PDF format first.",
          showConfirmButton: true,
          confirmButtonColor: '#3085d6',
        });
      } else {
        const file = resumeInput.files[0];
        if (file.type !== 'application/pdf') {
          // Check file type
          showSwal({
            icon: "error",
            title: "Invalid File Type",
            text: "Only PDF files are allowed. Please select a PDF file.",
            showConfirmButton: true,
            confirmButtonColor: '#3085d6',
          });
          return; // Exit if file type is not PDF
        }

        // Show loading SweetAlert
        showSwal({
          title: "Processing Resume",
          text: "Please wait while we evaluate your resume score...",
          allowOutsideClick: false,
          showConfirmButton: false, // No confirm button on loading
          didOpen: () => {
            Swal.showLoading(); // Show loading spinner
          },
          timer: null, // Don't auto-close
        });

        // Create a new FormData object to send the file via POST
        const formData = new FormData();
        formData.append("resume", resumeInput.files[0]);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Send the file to the backend via AJAX
        fetch("/testUserAuth/resume-score/", {
          method: "POST",
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest', // Ensures AJAX request
            'X-CSRFToken': csrfToken,
          },
        })
          .then(response => response.json())
          .then(data => {
            console.log("Backend response data:", data);

            const { score, result, resultClass } = data;
            console.log("Score:", score, "Category:", resultClass);

            // Close the loading alert
            if (currentSwal) currentSwal.close();

            // Show the result SweetAlert
            showSwal({
              title: "Resume Evaluation Result",
              text: `Your resume score is ${score}%`,
              icon: resultClass,
              customClass: {
                confirmButton: 'bg-blue-600 text-white',
              },
              html: `
                <div class="flex flex-col justify-center items-center">
                  <div class="relative w-24 h-24 border-4 rounded-full ${resultClass === 'success' ? 'border-green-500' : 'border-red-500'}">
                    <div class="absolute top-0 left-0 right-0 bottom-0 flex justify-center items-center">
                      <h1 class="text-5xl font-extrabold ${getTextColor(score)}">
                        <span class="whitespace-nowrap">${score}%</span>
                      </h1>
                    </div>
                  </div>
                  <div class="mt-1 text-lg font-semibold ${getClassificationClass(score)}">${getClassificationText(score)}!</div>
                </div>
              `,

              confirmButtonText: "Okay",
              confirmButtonColor: "#3085d6",
              timer: null,
            });
          })
          .catch(error => {
            console.error("Error:", error);

            // Close the loading alert
            if (currentSwal) currentSwal.close();

            // Show error alert
            showSwal({
              icon: "error",
              title: "Error",
              text: "An error occurred while processing your resume. Please try again later.",
              showConfirmButton: true,
              timer: null,
            });
          });
      }
    });


    // Function to get classification text based on score
    function getClassificationText(score) {
      if (score <= 10) {
        return 'Very Low';
      } else if (score <= 25) {
        return 'Low';
      } else if (score <= 50) {
        return 'Intermediate';
      } else if (score <= 75) {
        return 'Good';
      } else {
        return 'Excellent';
      }
    }

    // Function to get classification text color class
    function getClassificationClass(score) {
      if (score <= 10) {
        return 'text-red-600'; // Red for Very Poor
      } else if (score <= 25) {
        return 'text-orange-500'; // Light orange for Poor
      } else if (score <= 50) {
        return 'text-yellow-400'; // Dark yellow for Intermediate
      } else if (score <= 75) {
        return 'text-green-400'; // Parrot green for Good
      } else {
        return 'text-green-700'; // Fully green for Excellent
      }
    }
    // Function to determine the text color based on the score
    function getTextColor(score) {
      if (score <= 10) {
        return 'text-red-600'; // Red
      } else if (score <= 25) {
        return 'text-orange-500'; // Light orange
      } else if (score <= 50) {
        return 'text-yellow-400'; // Dark yellow
      } else if (score <= 75) {
        return 'text-green-400'; // Parrot green
      } else {
        return 'text-green-700'; // Fully green
      }
    }

    // Function to show SweetAlerts
    function showSwal(options) {
      if (currentSwal) {
        currentSwal.close(); // Ensure any previous SweetAlert is closed
      }
      currentSwal = Swal.fire(options); // Track the active SweetAlert
    }
  });
</script>







{% endblock %}